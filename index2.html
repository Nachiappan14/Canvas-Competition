<html>
<meta charset="utf-8">
<body onload="canvas.setup()"><!-- bgcolor="black"-->

    <canvas id="canvasArea1" style="position: absolute; left: 0; top: 0; z-index: 0; width:100%;height:100%"></canvas>
    <canvas id="canvasArea2"
        style="visibility: hidden; position: absolute; left: 0; top: 0; z-index: 0; width:100%;height:100%"></canvas>

    <script src="./canvas.js"></script>
</body>

</html>
<script>

    // Declare all global variables here
    velocity = 0;
    listenerslist = {};
    framex = canvas.width/2;
    var listOfObjects = [];
    function setup() {
        // Initialize variables here
        ball1 = new ball(100,canvas.height-30,30);
        wall1 =new BrickWall(500,500,100,500);
    }

    // Declare custom functions here
    function sleep(delay) {
        var start = new Date().getTime();
        while (new Date().getTime() < start + delay);
    }
    function renderall(){
        canvas.clear();
        canvas.setDrawMode("fill");
        console.log(listOfObjects);
        // console.log("renderingall");
        for(var i in listOfObjects)
            listOfObjects[i].render();
    }
    class ball{
        constructor(x,y,r){
            // console.log("1");
            this.r = r;
            if(r != 0){
                this.velocity = canvas.width/this.r*0.5;
                this.jumpVel = canvas.height*0.003 * this.r;
            }
            else{
                this.velocity = 100;
                this.jumpVel = 100;
            }
            listOfObjects.push(this);
            this.x = x;
            this.y = y;
            this.jumpTime = 150 ;
            this.upfreeze = false;
            this.addListener('ArrowRight');
            this.addListener('ArrowLeft');
            this.addListener('ArrowUp');
            // this.addListener('ArrowDown');
        }
        jump(){
            for(var i=0;i<this.jumpTime/2;i++)
            {
                // canvas.clear();
                console.log("y in jump="+this.y);
                this.y -= 10;
                // canvas.clear();
                renderall();
                // renderall();
                // sleep(1);
                // setTimeout(1);
                // sleep(timeStep/this.jumpTime);
            }
        }
        antiJump(){
            for(var i =0 ; i<this.jumpTime/2;i++)
            {
                // console.log(this.y,this.x);
                this.y += 10; 
                renderall();
                // sleep(1);
                // this.render();
                // setTimeout(1);
                // main();
                // sleep(timeStep/this.jumpTime);
            }
        }
        render(){
            console.log(this.x,this.y);
            for(var i = 0;i<10;i++)
            {
                canvas.setColor("rgb("+(230+i*2)+","+ i*20 +","+ i*5 +")");
                canvas.drawCircle(this.x,this.y,this.r-this.r/10*i);
            }
            // canvas.drawCircle(this.x,this.y,this.r-this.r/10);
            
            // if(this.y > canvas.height - this.r)
                // this.y = canvas.height - this.r;
        }
        addListener(k)
        {
            if(k in listenerslist)
                listenerslist[k].append(this);
            else{
                listenerslist[k] = [this,];
                // listenerslist[k].append(this);
            }
        }
        listen(e){
            // console.log("yes");
            if(e === "ArrowRight")
            {
                this.x = this.x + this.velocity;
                // canvas.drawText(400, 400,""+listenerslist['ArrowRight']+"");
            }
            else if(e === "ArrowLeft")
                this.x -= this.velocity;
            else if(e === "ArrowUp")
                if(!this.upfreeze)
                {
                    this.upfreeze = true;
                    this.jump();
                    sleep(timeStep/this.jumpTime/2);
                    this.antiJump();
                    sleep(timeStep/this.jumpTime/2);
                    this.upfreeze = false;
                }
            else if(e === "ArrowDown")
                this.y += this.velocity;
        }
    }

    class BrickWall{
        constructor(x,y=0,w,h){
            this.x = x;
            this.y = canvas.height - h;
            this.w = w;
            this.h = h;
            listOfObjects.push(this);
            this.render();
        }
        render(){
            canvas.setColor("skyblue");
            canvas.drawRectangle(this.x,this.y,this.w,this.h);
        }
    }

    // Function while will be called repeatedly 
    function main() {
        canvas.setDrawMode("fill");
        renderall();
        // ball(canvas.mouseX,canvas.mouseY,20);
        // canvas.drawRectangle(0,0,100,100);
        // listeners();
        
    }

    // Override functions here; 

    canvas.keyDownCallback = function(e){
        for(var i in listenerslist[e.code])
        {
            listenerslist[e.code][i].listen(e.code);
        }
    }
    
    canvas.setupFunction = setup;
    canvas.mainFunction = main;

    var timeStep = 500;
    canvas.startMain(timeStep);
    

</script>